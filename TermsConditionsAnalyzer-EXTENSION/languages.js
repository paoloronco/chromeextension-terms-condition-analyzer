// Language strings for the extension
const translations = {
    en: {
        // Dashboard
        dashboardTitle: 'Legaly Dashboard',
        privacySettings: 'Privacy Settings',
        extensionSettings: 'Extension Settings',
        about: 'About',
        yourPrivacyPreferences: 'Your Privacy Preferences',
        hiddenFees: 'Hidden Fees',
        hiddenFeesDesc: 'Hidden fees not highlighted in the terms.',
        dataCollection: 'Data Collection',
        dataCollectionDesc: 'Information collected about you during use.',
        targetedAds: 'Targeted Advertising',
        targetedAdsDesc: 'Personalized advertising based on your profile.',
        dataRetention: 'Data Retention',
        dataRetentionDesc: 'How long your data is kept.',
        rightToDelete: 'Right to Delete',
        rightToDeleteDesc: 'Ability to delete your data on request.',
        dataSharing: 'Data Sharing with Third Parties',
        dataSharingDesc: 'Whether your data is shared with third parties.',
        language: 'Language',
        aboutTitle: 'About Legaly',
        aboutText1: 'Legaly is a powerful browser extension designed to make complex legal documents easy to understand. It uses advanced AI to analyze Terms and Conditions or Privacy Policies on any webpage, providing you with a clear and concise summary of the most important points.',
        aboutText2: 'How it works: Simply click the \'Analyze\' button in the popup, and the extension will read the page content and send it to our secure backend for analysis. You\'ll receive a summary that highlights key areas like data collection, hidden fees, and your rights, helping you make informed decisions online.',
        version: 'Version',
        
        // Popup
        popupTitle: 'Legaly',
        analyzeBtn: 'Analyze Terms & Conditions',
        dashboardBtn: 'Dashboard',
        analyzing: 'Analyzing...',
        errorOccurred: 'An error occurred. Please try again.',
        noContent: 'No content found to analyze.',
        analysisComplete: 'Analysis complete!',
        viewDetails: 'View Details',
        close: 'Close',
        howItWorks: 'How It Works',
        copyright: '© Copyright 2025 Legaly. All rights reserved.'
    },
    es: {
        // Dashboard
        dashboardTitle: 'Panel de Legaly',
        privacySettings: 'Configuración de privacidad',
        extensionSettings: 'Configuración de la extensión',
        about: 'Acerca de',
        yourPrivacyPreferences: 'Tus preferencias de privacidad',
        hiddenFees: 'Tarifas ocultas',
        hiddenFeesDesc: 'Tarifas ocultas no resaltadas en los términos.',
        dataCollection: 'Recopilación de datos',
        dataCollectionDesc: 'Información recopilada sobre ti durante el uso.',
        targetedAds: 'Publicidad dirigida',
        targetedAdsDesc: 'Publicidad personalizada según tu perfil.',
        dataRetention: 'Retención de datos',
        dataRetentionDesc: 'Cuánto tiempo se conservan tus datos.',
        rightToDelete: 'Derecho a eliminar',
        rightToDeleteDesc: 'Posibilidad de eliminar tus datos bajo petición.',
        dataSharing: 'Compartir datos con terceros',
        dataSharingDesc: 'Si tus datos se comparten con terceros.',
        language: 'Idioma',
        aboutTitle: 'Acerca de Legaly',
        aboutText1: 'Legaly es una potente extensión de navegador diseñada para hacer que los documentos legales complejos sean fáciles de entender. Utiliza IA avanzada para analizar los Términos y Condiciones o las Políticas de Privacidad en cualquier página web, proporcionándote un resumen claro y conciso de los puntos más importantes.',
        aboutText2: 'Cómo funciona: Simplemente haz clic en el botón \'Analizar\' en la ventana emergente, y la extensión leerá el contenido de la página y lo enviará a nuestro servidor seguro para su análisis. Recibirás un resumen que destaca áreas clave como la recopilación de datos, tarifas ocultas y tus derechos, ayudándote a tomar decisiones informadas en línea.',
        version: 'Versión',
        
        // Popup
        popupTitle: 'Legaly',
        analyzeBtn: 'Analizar Términos y Condiciones',
        dashboardBtn: 'Panel de control',
        analyzing: 'Analizando...',
        errorOccurred: 'Ocurrió un error. Por favor, inténtalo de nuevo.',
        noContent: 'No se encontró contenido para analizar.',
        analysisComplete: '¡Análisis completado!',
        viewDetails: 'Ver detalles',
        close: 'Cerrar',
        howItWorks: 'Cómo funciona',
        copyright: '© Copyright 2025 Legaly. Todos los derechos reservados.'
    },
    it: {
        // Dashboard
        dashboardTitle: 'Pannello di Legaly',
        privacySettings: 'Impostazioni sulla privacy',
        extensionSettings: 'Impostazioni estensione',
        about: 'Informazioni',
        yourPrivacyPreferences: 'Le tue preferenze sulla privacy',
        hiddenFees: 'Costi nascosti',
        hiddenFeesDesc: 'Costi nascosti non evidenziati nei termini.',
        dataCollection: 'Raccolta dati',
        dataCollectionDesc: 'Informazioni raccolte su di te durante l\'uso.',
        targetedAds: 'Pubblicità mirata',
        targetedAdsDesc: 'Pubblicità personalizzata in base al tuo profilo.',
        dataRetention: 'Conservazione dei dati',
        dataRetentionDesc: 'Per quanto tempo vengono conservati i tuoi dati.',
        rightToDelete: 'Diritto alla cancellazione',
        rightToDeleteDesc: 'Possibilità di eliminare i tuoi dati su richiesta.',
        dataSharing: 'Condivisione dati con terze parti',
        dataSharingDesc: 'Se i tuoi dati vengono condivisi con altri soggetti.',
        language: 'Lingua',
        aboutTitle: 'Informazioni su Legaly',
        aboutText1: 'Legaly è un\'estensione del browser progettata per rendere comprensibili documenti legali complessi. Utilizza l\'intelligenza artificiale per analizzare i Termini e Condizioni o le Norme sulla Privacy su qualsiasi pagina web, fornendoti un riepilogo chiaro e conciso dei punti più importanti.',
        aboutText2: 'Come funziona: Basta fare clic sul pulsante \'Analizza\' nel popup e l\'estensione leggerà il contenuto della pagina e lo invierà al nostro server sicuro per l\'analisi. Riceverai un riepilogo che evidenzia aree chiave come la raccolta dati, i costi nascosti e i tuoi diritti, aiutandoti a prendere decisioni informate online.',
        version: 'Versione',
        
        // Popup
        popupTitle: 'Legaly',
        analyzeBtn: 'Analizza Termini e Condizioni',
        dashboardBtn: 'Pannello di controllo',
        analyzing: 'Analisi in corso...',
        errorOccurred: 'Si è verificato un errore. Riprova.',
        noContent: 'Nessun contenuto da analizzare.',
        analysisComplete: 'Analisi completata!',
        viewDetails: 'Visualizza dettagli',
        close: 'Chiudi',
        howItWorks: 'Come Funziona',
        copyright: '© Copyright 2025 Legaly. Tutti i diritti riservati.',
        analysisInProgress: 'Analisi in corso...',
        overallRating: 'Valutazione complessiva',
        categoryRatings: 'Valutazioni delle categorie',
        summary: 'Riepilogo'
    },
    fr: {
        // Dashboard
        dashboardTitle: 'Tableau de bord Legaly',
        privacySettings: 'Paramètres de confidentialité',
        extensionSettings: 'Paramètres de l\'extension',
        about: 'À propos',
        yourPrivacyPreferences: 'Vos préférences de confidentialité',
        hiddenFees: 'Frais cachés',
        hiddenFeesDesc: 'Frais cachés non mis en évidence dans les conditions.',
        dataCollection: 'Collecte de données',
        dataCollectionDesc: 'Informations collectées sur vous pendant l\'utilisation.',
        targetedAds: 'Publicité ciblée',
        targetedAdsDesc: 'Publicité personnalisée basée sur votre profil.',
        dataRetention: 'Conservation des données',
        dataRetentionDesc: 'Durée de conservation de vos données.',
        rightToDelete: 'Droit à l\'oubli',
        rightToDeleteDesc: 'Possibilité de supprimer vos données sur demande.',
        dataSharing: 'Partage de données avec des tiers',
        dataSharingDesc: 'Si vos données sont partagées avec des tiers.',
        language: 'Langue',
        aboutTitle: 'À propos de Legaly',
        aboutText1: 'Legaly est une puissante extension de navigateur conçue pour rendre les documents juridiques complexes faciles à comprendre. Elle utilise une IA avancée pour analyser les Conditions Générales ou les Politiques de Confidentialité sur n\'importe quelle page Web, vous fournissant un résumé clair et concis des points les plus importants.',
        aboutText2: 'Comment ça marche : Cliquez simplement sur le bouton \'Analyser\' dans la fenêtre contextuelle, et l\'extension lira le contenu de la page et l\'enverra à notre serveur sécurisé pour analyse. Vous recevrez un résumé mettant en évidence des domaines clés comme la collecte de données, les frais cachés et vos droits, vous aidant à prendre des décisions éclairées en ligne.',
        version: 'Version',
        
        // Popup
        popupTitle: 'Legaly',
        analyzeBtn: 'Analyser les Conditions Générales',
        dashboardBtn: 'Tableau de bord',
        analyzing: 'Analyse en cours...',
        errorOccurred: 'Une erreur est survenue. Veuillez réessayer.',
        noContent: 'Aucun contenu trouvé à analyser.',
        analysisComplete: 'Analyse terminée !',
        viewDetails: 'Voir les détails',
        close: 'Fermer',
        howItWorks: 'Comment ça marche',
        copyright: '© Copyright 2025 Legaly. Tous droits réservés.'
    },
    de: {
        // Dashboard
        dashboardTitle: 'Legaly Dashboard',
        privacySettings: 'Datenschutzeinstellungen',
        extensionSettings: 'Erweiterungseinstellungen',
        about: 'Über',
        yourPrivacyPreferences: 'Ihre Datenschutzeinstellungen',
        hiddenFees: 'Versteckte Gebühren',
        hiddenFeesDesc: 'In den Bedingungen nicht hervorgehobene versteckte Gebühren.',
        dataCollection: 'Datenerfassung',
        dataCollectionDesc: 'Während der Nutzung über Sie gesammelte Informationen.',
        targetedAds: 'Zielgerichtete Werbung',
        targetedAdsDesc: 'Personalisierte Werbung basierend auf Ihrem Profil.',
        dataRetention: 'Datenaufbewahrung',
        dataRetentionDesc: 'Wie lange Ihre Daten gespeichert werden.',
        rightToDelete: 'Recht auf Löschung',
        rightToDeleteDesc: 'Möglichkeit, Ihre Daten auf Anfrage zu löschen.',
        dataSharing: 'Datenweitergabe an Dritte',
        dataSharingDesc: 'Ob Ihre Daten mit Dritten geteilt werden.',
        language: 'Sprache',
        aboutTitle: 'Über Legaly',
        aboutText1: 'Legaly ist eine leistungsstarke Browsererweiterung, die komplexe Rechtsdokumente leicht verständlich macht. Sie nutzt fortschrittliche KI, um Allgemeine Geschäftsbedingungen oder Datenschutzrichtlinien auf jeder Webseite zu analysieren und liefert Ihnen eine klare und prägnante Zusammenfassung der wichtigsten Punkte.',
        aboutText2: 'So funktioniert\'s: Klicken Sie einfach auf die Schaltfläche \'Analysieren\' im Popup, und die Erweiterung wird den Seiteninhalt lesen und zur Analyse an unser sicheres Backend senden. Sie erhalten eine Zusammenfassung, die wichtige Bereiche wie Datenerfassung, versteckte Gebühren und Ihre Rechte hervorhebt, damit Sie fundierte Entscheidungen im Internet treffen können.',
        version: 'Version',
        
        // Popup
        popupTitle: 'Legaly',
        analyzeBtn: 'AGB analysieren',
        dashboardBtn: 'Dashboard',
        analyzing: 'Analyse läuft...',
        errorOccurred: 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.',
        noContent: 'Kein Inhalt zum Analysieren gefunden.',
        analysisComplete: 'Analyse abgeschlossen!',
        viewDetails: 'Details anzeigen',
        close: 'Schließen',
        howItWorks: 'Wie es funktioniert',
        copyright: '© Copyright 2025 Legaly. Alle Rechte vorbehalten.',
        analysisInProgress: 'Analyse wird durchgeführt...',
        overallRating: 'Gesamtbewertung',
        categoryRatings: 'Kategoriebewertungen',
        summary: 'Zusammenfassung'
    }
};

// Export the setLanguage function for use in other files
window.setLanguage = setLanguage;

// Function to get a translated string
function getString(key, lang = null) {
  try {
    // If no language specified, try to get it from the document or default to English
    if (!lang) {
      if (typeof document !== 'undefined' && document.documentElement) {
        lang = document.documentElement.lang || 'en';
      } else {
        lang = 'en';
      }
    }
    
    // If the language isn't supported, default to English
    if (!translations[lang]) {
      console.warn(`Language '${lang}' not supported, falling back to English`);
      lang = 'en';
    }
    
    // Get the translation or return the key if not found
    const translation = translations[lang][key] || translations['en'][key] || key;
    
    // If we still just have the key, log a warning
    if (translation === key && !translations[lang][key]) {
      console.warn(`No translation found for key '${key}' in language '${lang}'`);
    }
    
    return translation;
  } catch (error) {
    console.error(`Error getting translation for key '${key}' in language '${lang}':`, error);
    return key; // Return the key as fallback
  }
}

// Function to set the language for the page
async function setLanguage(lang = null) {
  try {
    console.log('setLanguage called with:', lang);
    
    // If no language provided, try to get it from storage or browser
    if (!lang || lang === 'browser') {
      if (typeof chrome !== 'undefined' && chrome.storage) {
        try {
          const result = await new Promise((resolve, reject) => {
            chrome.storage.local.get('language', (result) => {
              if (chrome.runtime.lastError) {
                reject(chrome.runtime.lastError);
              } else {
                resolve(result);
              }
            });
          });
          
          lang = result.language || navigator.language.split('-')[0] || 'en';
          console.log('Retrieved language from storage:', lang);
        } catch (error) {
          console.warn('Error getting language from storage, using browser language:', error);
          lang = navigator.language.split('-')[0] || 'en';
        }
      } else {
        lang = navigator.language.split('-')[0] || 'en';
      }
    }
    
    // Normalize language code (e.g., en-US -> en)
    lang = lang.split('-')[0].toLowerCase();
    
    // If the language isn't supported, default to English
    if (!translations[lang]) {
      console.warn(`Language '${lang}' not supported, falling back to English`);
      lang = 'en';
    }
    
    // Set the document language
    if (typeof document !== 'undefined' && document.documentElement) {
      document.documentElement.lang = lang;
      console.log('Document language set to:', lang);
    }
    
    // Save the language preference
    if (typeof chrome !== 'undefined' && chrome.storage) {
      try {
        await new Promise((resolve, reject) => {
          chrome.storage.local.set({ language: lang }, () => {
            if (chrome.runtime.lastError) {
              reject(chrome.runtime.lastError);
            } else {
              resolve();
            }
          });
        });
        console.log('Language preference saved:', lang);
      } catch (error) {
        console.error('Error saving language preference:', error);
      }
    }
    
    // Trigger language change event
    if (typeof document !== 'undefined') {
      const event = new CustomEvent('languageChanged', { 
        detail: { language: lang } 
      });
      document.dispatchEvent(event);
      console.log('Dispatched languageChanged event for language:', lang);
    }
    
    return lang;
  } catch (error) {
    console.error('Error in setLanguage:', error);
    return 'en'; // Default to English on error
  }
}

// Listen for language changes from other parts of the extension
if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.onMessage) {
  chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    if (request.action === 'languageChanged' && request.language) {
      console.log('Received language change message:', request.language);
      
      // Update the document language
      if (typeof document !== 'undefined' && document.documentElement) {
        document.documentElement.lang = request.language;
      }
      
      // Dispatch a custom event that other scripts can listen for
      if (typeof document !== 'undefined') {
        const event = new CustomEvent('languageChanged', { 
          detail: { language: request.language } 
        });
        document.dispatchEvent(event);
        console.log('Dispatched languageChanged event from message listener');
      }
      
      // Send response if this is a synchronous message
      if (sendResponse) {
        sendResponse({ success: true });
      }
      
      // Return true to indicate we'll send a response asynchronously
      return true;
    }
  });
}

// Initialize with browser language when the script loads
if (typeof document !== 'undefined') {
  document.addEventListener('DOMContentLoaded', () => {
    setLanguage();
  });
}
